---
title: "speciesLatin Data Preparation"
format: 
  html:
    toc: true
    toc-location: right
    smooth-scroll: true
    html-math-method: katex
    code-fold: true
self-contained: true
editor: source
author: 'Florencia Grattarola'
date: "`r format(Sys.time(), '%Y-%m-%d')`"
---

Data preparation for modelling for *speciesLatin*, with the covariates `bio2`, `bio14`, `elev`, and `grass` (selected in the previous step).

  - R Libraries

```{r}
#| label: libraries
#| message: false
#| warning: false
#| code-fold: false

library(knitr)
library(lubridate)
library(tmap)
library(leaflet)
library(patchwork)
library(terra)
library(sf)
sf::sf_use_s2(FALSE)
library(tidyverse)
```

  - Basemaps

```{r}
#| label: basemaps
#| message: false
#| warning: false
#| code-fold: false

equalareaCRS <-  '+proj=laea +lon_0=-73.125 +lat_0=0 +datum=WGS84 +units=m +no_defs'
Latam_projected <- st_read('data/Latam_vector.shp', quiet = T)
Latam_countries <- sf::st_read('data/Latam_vector_countries.shp', quiet = T) %>% sf::st_transform(crs=equalareaCRS)
Latam <- st_union(st_make_valid(Latam_projected))
Latam.raster <- terra::rast('data/Latam_raster.tif')
Latam.raster.countries <- terra::rast('data/Latam_raster_countries.tif')

# IUCN range distribution
speciesAbrev_IUCN <- sf::st_read('big_data/speciesAbrev_IUCN.shp', quiet = T) %>% sf::st_transform(crs=equalareaCRS)

MAP.IUCN <- tm_graticules(alpha = 0.3) +
    tm_shape(Latam_countries) +
    tm_fill(col='grey90') +
    tm_borders(col='grey60', alpha = 0.4) +
    tm_shape(speciesAbrev_IUCN) +
    tm_fill(col='grey20', alpha = 0.4) +
    tm_layout(legend.outside = T, frame.lwd = 0.3, scale=1.2, legend.outside.size = 0.1)

MAP.IUCN
```

## Data

### Species data (PA & PO)

```{r}
#| label: data
#| message: false
#| warning: false
#| code-fold: false

# presence-only rasters
PO_speciesAbrev_time1_raster <- terra::rast('data/PO_speciesAbrev_time1_raster.tif')
PO_speciesAbrev_time2_raster <- terra::rast('data/PO_speciesAbrev_time2_raster.tif')

# blobs
PA_speciesAbrev_time1_blobs <- readRDS('data/PA_speciesAbrev_time1_blobs.rds')
PA_speciesAbrev_time2_blobs <- readRDS('data/PA_speciesAbrev_time2_blobs.rds')
```


### Covariates

The following covariates were chosen using the 'variableSelection' script:

 - `bio2`: Temperature Annual Range
 - `bio14`: Mean Temperature of Warmest Quarter
 - `elev`: Net Primary Production (elev)
 - `grass`: Percentage of No Tree Cover

``` {r}
#| echo: true
#| eval: true
#| label: covariates
#| message: false
#| warning: false

elev <- rast(here::here('big_data/elev_high.tif'))
bio <- rast(here::here('big_data/bio_high.tif'))
grass <- rast(here::here('big_data/grass_high.tif'))
grass <- resample(grass, bio, method='bilinear') 
names(grass) <- 'grass'

# environmental layers for PA
env <- c(bio[[c('bio_2','bio_14')]], grass, elev) %>% 
  classify(cbind(NaN, NA))

# resample and scaled values for PO
env_100k_resampled <- terra::resample(env, Latam.raster, method='bilinear') %>% 
  classify(cbind(NaN, NA)) %>% scale() # scaled values to 0 mean and sd of 1
```

#### Plots

```{r}
#| echo: true
#| eval: true
#| label: covariates-plots
#| message: false
#| warning: false
#| code-fold: false

# use unscaled values
env_100k_resampled <- terra::resample(env, Latam.raster, method='bilinear') %>% 
  classify(cbind(NaN, NA))

grass.plot <- tm_graticules(alpha = 0.3) +  
    tm_shape(env_100k_resampled[["grass"]]) +
    tm_raster(palette = 'YlGn', midpoint = NA, style= "cont")  + 
    tm_shape(Latam_projected) +
    tm_borders(alpha = 0.3) + 
    tm_layout(legend.outside = T, frame.lwd = 0.3, scale=1.2, legend.outside.size = 0.1)

elev.plot <- tm_graticules(alpha = 0.3) +  
    tm_shape(env_100k_resampled[["elev"]]) +
    tm_raster(palette = 'BrBG', midpoint = NA, style= "cont")  + 
    tm_shape(Latam_projected) +
    tm_borders(alpha = 0.3) + 
    tm_layout(legend.outside = T, frame.lwd = 0.3, scale=1.2, legend.outside.size = 0.1)

bio_2.plot <- tm_graticules(alpha = 0.3) +  
    tm_shape(env_100k_resampled[["bio_2"]]) +
    tm_raster(palette = 'PuRd', midpoint = NA, style= "cont")  + 
    tm_shape(Latam_projected) +
    tm_borders(alpha = 0.3) + 
    tm_layout(legend.outside = T, frame.lwd = 0.3, scale=1.2, legend.outside.size = 0.1)

bio_14.plot <- tm_graticules(alpha = 0.3) +  
    tm_shape(env_100k_resampled[["bio_14"]]) +
    tm_raster(palette = 'PuBu', midpoint = NA, style= "cont")  + 
    tm_shape(Latam_projected) +
    tm_borders(alpha = 0.3) + 
    tm_layout(legend.outside = T, frame.lwd = 0.3, scale=1.2, legend.outside.size = 0.1)

grass.plot 
elev.plot
bio_2.plot
bio_14.plot
```

### Thinning parametres 

 - `acce`: Accessibility
 - `country`: Country of origin
 
``` {r}
#| echo: true
#| eval: true
#| label: thinning-parameters
#| message: false
#| warning: false

acce_100k_resampled <- terra::rast('big_data/acce.tif') %>% 
  classify(cbind(NaN, NA)) # values are scaled
```

#### Plot

```{r}
#| echo: true
#| eval: true
#| label: thinning-plots
#| message: false
#| warning: false
#| code-fold: false

acce.plot <- tm_graticules(alpha = 0.3) +  
    tm_shape(acce_100k_resampled[["acce"]]) +
    tm_raster(palette = 'RdYlBu', midpoint = NA, style= "cont", n=10)  + 
    tm_shape(Latam_projected) +
    tm_borders(alpha = 0.3) + 
    tm_layout(legend.outside = T, frame.lwd = 0.3, scale=1.2, legend.outside.size = 0.1)

acce.plot
```

## Data for the model

### Presence-only data

``` {r}
#| echo: true
#| eval: true
#| label: PO-data-for-model
#| message: false
#| warning: false

# calculate area in each raster cell
PO_speciesAbrev.area <- terra::cellSize(PO_speciesAbrev_time1_raster[[1]], unit='m', transform=F) %>% 
  classify(cbind(NaN, NA)) %>% terra::values()

# calculate coordinates for each raster cell
PO_speciesAbrev.coords <- terra::xyFromCell(PO_speciesAbrev_time1_raster, cell=1:ncell(PO_speciesAbrev_time1_raster)) %>% as.data.frame()
names(PO_speciesAbrev.coords) <- c('X', 'Y')

# number of cells in the rasters (both the same)
PO_speciesAbrev.cell <- 1:ncell(PO_speciesAbrev_time1_raster)

# with the environmental variables values for each cell
PO_speciesAbrev.env <- env_100k_resampled[] # scaled values

# with the mean accessibility value for each cell
PO_speciesAbrev.acce <- acce_100k_resampled # scaled values

# calculate point count in each raster cell
PO_speciesAbrev_time1.count <- PO_speciesAbrev_time1_raster %>%
    classify(cbind(NaN, NA)) %>% terra::values() %>% as_tibble %>% 
  dplyr::select(count)

PO_speciesAbrev_time2.count <- PO_speciesAbrev_time2_raster %>%
    classify(cbind(NaN, NA)) %>% terra::values() %>% as_tibble %>% 
  dplyr::select(count)

PO_speciesAbrev.countries <- Latam.raster.countries %>% classify(cbind(NaN, NA))

# save time1 and time2 datasets 
PO_speciesAbrev_time1.model.data <- data.frame(PO_speciesAbrev.coords,
                                            pixel = PO_speciesAbrev.cell[],
                                            area = PO_speciesAbrev.area,
                                            pt.count = PO_speciesAbrev_time1.count,
                                            env = PO_speciesAbrev.env,
                                            acce = PO_speciesAbrev.acce[], 
                                            country = PO_speciesAbrev.countries[])

PO_speciesAbrev_time2.model.data <- data.frame(PO_speciesAbrev.coords,
                                            pixel = PO_speciesAbrev.cell[],
                                            area = PO_speciesAbrev.area,
                                            pt.count = PO_speciesAbrev_time2.count,
                                            env = PO_speciesAbrev.env,
                                            acce = PO_speciesAbrev.acce[], 
                                            country = PO_speciesAbrev.countries[])

```

 - Check data

```{r}
#| echo: true
#| eval: true
#| label: PO-data-for-model-check
#| message: false
#| warning: false

head(PO_speciesAbrev_time1.model.data) %>% kable()
head(PO_speciesAbrev_time2.model.data) %>% kable()
```

### Presence-absence data 

```{r}
#| echo: true
#| eval: true
#| label: PA-data-for-model
#| message: false
#| warning: false

# calculate area, coordinates, and point count in each raster cell
PA_speciesAbrev.area.time1 <- as.numeric(PA_speciesAbrev_time1_blobs$blobArea) 
PA_speciesAbrev.area.time2 <- as.numeric(PA_speciesAbrev_time2_blobs$blobArea) 

PA_speciesAbrev.coords.time1 <- st_coordinates(st_centroid(PA_speciesAbrev_time1_blobs)) %>% as_tibble()
PA_speciesAbrev.coords.time2 <- st_coordinates(st_centroid(PA_speciesAbrev_time2_blobs)) %>% as_tibble()

PA_speciesAbrev.pixel.time1 <- terra::cells(PO_speciesAbrev_time1_raster, vect(st_centroid(PA_speciesAbrev_time1_blobs))) 
PA_speciesAbrev.pixel.time2 <- terra::cells(PO_speciesAbrev_time2_raster, vect(st_centroid(PA_speciesAbrev_time2_blobs))) 

# mode to calculate the most frequent value for the blob - this needs to be changed to getting the %are for each landcover
mode_raster  <- function(x, na.rm = FALSE) {
  if(na.rm){ x = x[!is.na(x)]}
  ux <- unique(x)
  return(ux[which.max(tabulate(match(x, ux)))])
}

PA_speciesAbrev.env.time1 <- terra::extract(x = env, y = vect(PA_speciesAbrev_time1_blobs), fun = mean, rm.na=T) %>% 
  mutate(across(where(is.numeric), ~ifelse(is.nan(.), NA, .))) %>% scale()

PA_speciesAbrev.env.time2 <- terra::extract(x = env, y = vect(PA_speciesAbrev_time2_blobs), fun = mean, rm.na=T) %>% 
  mutate(across(where(is.numeric), ~ifelse(is.nan(.), NA, .))) %>% scale()

PA_speciesAbrev_time1.model.data <- data.frame(pixel = PA_speciesAbrev.pixel.time1, 
                                            PA_speciesAbrev.coords.time1,
                                            area = PA_speciesAbrev.area.time1,
                                            presabs = PA_speciesAbrev_time1_blobs$presence,
                                            effort = PA_speciesAbrev_time1_blobs$effort,
                                            env = PA_speciesAbrev.env.time1[,2:5])

PA_speciesAbrev_time2.model.data <- data.frame(pixel = PA_speciesAbrev.pixel.time2, 
                                            PA_speciesAbrev.coords.time2,
                                            area = PA_speciesAbrev.area.time2,
                                            presabs = PA_speciesAbrev_time2_blobs$presence,
                                            effort = PA_speciesAbrev_time2_blobs$effort,
                                            env = PA_speciesAbrev.env.time2[,2:5])

```

  - Check data

```{r}
#| echo: true
#| eval: true
#| label: PA-data-for-model-check
#| message: false
#| warning: false

head(PA_speciesAbrev_time1.model.data) %>% kable()
head(PA_speciesAbrev_time2.model.data) %>% kable()
```


## Save data

```{r}
#| echo: true
#| eval: true
#| label: save-data
#| message: false
#| warning: false
#| code-fold: false

saveRDS(PO_speciesAbrev_time1.model.data, 'data/data_speciesAbrev_PO_time1.rds')
saveRDS(PO_speciesAbrev_time2.model.data, 'data/data_speciesAbrev_PO_time2.rds')
saveRDS(PA_speciesAbrev_time1.model.data, 'data/data_speciesAbrev_PA_time1.rds')
saveRDS(PA_speciesAbrev_time2.model.data, 'data/data_speciesAbrev_PA_time2.rds')
```


## Extra: Datasets in the covariate space

The range (and interquartile range) of values for each covariate that is sampled by each dataset

```{r}
#| echo: true
#| eval: true
#| label: IQR
#| message: false
#| warning: false

getRangeIQR <- function(env_PX){
  env_PX.df <- tibble(env= character(),
                          range = numeric(),
                     iqr = numeric(),
                     stringsAsFactors=FALSE)
  
  for (i in 1:ncol(env_PX)){
    df <- tibble(env = names(env_PX[i]),
             range = range(env_PX[[i]], na.rm=T)[2],
             iqr=  IQR(env_PA[[i]], na.rm = T))
    env_PX.df <- rbind(env_PX.df, df)
  }
  return(env_PX.df)
}

# covariates for PA
env_PA <- terra::extract(x = env, 
                         y = rbind(vect(PA_speciesAbrev_time1_blobs), 
                                   vect(PA_speciesAbrev_time2_blobs)), 
                                     fun = mean, rm.na=T) %>% 
  mutate(across(where(is.numeric), ~ifelse(is.nan(.), NA, .))) 

summary(env_PA[-1])

env_PA.RangeIQR <- getRangeIQR(env_PA[-1]) %>% mutate(data='PA')

for (i in 2:ncol(env_PA)){
    range <- range(env_PA[[i]], na.rm=T)[2]
    iqr <- IQR(env_PA[[i]], na.rm = T)
    print(str_glue('PA {names(env_PA[i])} -> range: {range} - IQR: {iqr}'))
}

# covariates layers for PO
env_PO <- terra::resample(env, Latam.raster, method='bilinear') %>% 
  classify(cbind(NaN, NA)) %>% as.data.frame()

summary(env_PO)

env_PO.RangeIQR <- getRangeIQR(env_PO) %>% mutate(data='PO')

for (i in 1:ncol(env_PO)){
    range <- range(env_PO[[i]], na.rm=T)[2]
    iqr <- IQR(env_PO[[i]], na.rm = T)
    print(str_glue('PO {names(env_PO[i])} -> range: {range} - IQR: {iqr}'))
}
```

